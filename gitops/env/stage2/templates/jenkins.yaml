# Copyright (c) 2024-2025 Accenture, All Rights Reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#         http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: jenkins
  namespace: argocd
  annotations:
    argocd.argoproj.io/sync-wave: "6"
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: horizon-sdv
  source:
    chart: jenkins
    repoURL: https://charts.jenkins.io
    targetRevision: 5.8.2
    helm:
      values: |
        persistence:
          accessMode: "ReadWriteOnce"
          enabled: true
          existingClaim: "jenkins-home-volume"
        rbac:
          readSecrets: true
        agent:
          containerCap: 20
        controller:
          sidecars:
            configAutoReload:
              enabled: false
          jenkinsUriPrefix: /jenkins
          admin:
            createSecret: true
            existingSecret: jenkins-initial-creds
            userkey: jenkins-admin-user
            passwordkey: jenkins-admin-password
          jenkinsUrl: https://{{ .Values.config.domain }}/jenkins
          installPlugins:
            - antisamy-markup-formatter:173.v680e3a_b_69ff3
            - apache-httpcomponents-client-4-api:4.5.14-269.vfa_2321039a_83
            - asm-api:9.7.1-97.v4cc844130d97
            - authentication-tokens:1.131.v7199556c3004
            - bootstrap5-api:5.3.3-2
            - bouncycastle-api:2.30.1.80-256.vf98926042a_9b_
            - branch-api:2.1214.v3f652804588d
            - caffeine-api:3.2.0-161.v691ef352cee1
            - checks-api:367.v18b_7f530e54a_
            - cloudbees-folder:6.982.vf165a_16c9507
            - commons-lang3-api:3.17.0-84.vb_b_938040b_078
            - commons-text-api:1.13.0-153.v91dcd89e2a_22
            - command-launcher:115.vd8b_301cc15d0
            - configuration-as-code:1932.v75cb_b_f1b_698d
            - credentials-binding:687.v619cb_15e923f
            - credentials:1408.va_622a_b_f5b_1b_1
            - display-url-api:2.209.v582ed814ff2f
            - durable-task:587.v84b_877235b_45
            - echarts-api:5.6.0-2
            - eddsa-api:0.3.0-13.v7cb_69ed68f00
            - font-awesome-api:6.7.2-1
            - git-client:6.1.2
            - git:5.7.0
            - github-api:1.321-478.vc9ce627ce001
            - github:1.42.0
            - google-oauth-plugin:1.330.vf5e86021cb_ec
            - gson-api:2.12.1-113.v347686d6729f
            - instance-identity:201.vd2a_b_5a_468a_a_6
            - ionicons-api:82.v0597178874e1
            - jackson2-api:2.17.0-389.va_5c7e45cd806
            - jakarta-activation-api:2.1.3-2
            - jakarta-mail-api:2.1.3-2
            - javax-activation-api:1.2.0-8
            - javax-mail-api:1.6.2-10
            - jaxb:2.3.9-133.vb_ec76a_73f706
            - jdk-tool:80.v8a_dee33ed6f0
            - jjwt-api:0.11.5-120.v0268cf544b_89
            - joda-time-api:2.13.1-115.va_6b_5f8efb_1d8
            - jquery3-api:3.7.1-3
            - jsch:0.2.16-95.v3eecb_55fa_b_78
            - json-api:20250107-125.v28b_a_ffa_eb_f01
            - json-path-api:2.9.0-148.v22a_7ffe323ce
            - junit:1317.v5b_35d792b_06a_
            - kubernetes-client-api:6.10.0-240.v57880ce8b_0b_2
            - kubernetes-credentials-provider:1.273.v15e69b_55ea_8e
            - mailer:489.vd4b_25144138f
            - matrix-project:845.vffd7fa_f27555
            - metrics:4.2.21-464.vc9fa_a_0d6265d
            - mina-sshd-api-common:2.14.0-143.v2b_362fc39576
            - mina-sshd-api-core:2.14.0-143.v2b_362fc39576
            - oauth-credentials:0.653.v14cf2088e950
            - okhttp-api:4.11.0-183.va_87fc7a_89810
            - pipeline-build-step:557.v95d96f77b_2b_8
            - pipeline-graph-analysis:231.v56354571a_da_0
            - pipeline-groovy-lib:752.vdddedf804e72
            - pipeline-input-step:515.v8857b_eb_b_910c
            - pipeline-milestone-step:127.vb_52887ca_3b_6d
            - pipeline-model-api:2.2234.v4a_b_13b_8cd590
            - pipeline-model-definition:2.2234.v4a_b_13b_8cd590
            - pipeline-model-extensions:2.2234.v4a_b_13b_8cd590
            - pipeline-rest-api:2.37
            - pipeline-stage-step:322.vecffa_99f371c
            - pipeline-stage-tags-metadata:2.2234.v4a_b_13b_8cd590
            - plain-credentials:183.va_de8f1dd5a_2b_
            - plugin-util-api:6.0.0
            - prism-api:1.29.0-19
            - scm-api:704.v3ce5c542825a_
            - script-security:1373.vb_b_4a_a_c26fa_00
            - snakeyaml-api:2.3-123.v13484c65210a_
            - ssh-credentials:349.vb_8b_6b_9709f5b_
            - sshd:3.330.vc866a_8389b_58
            - structs:343.vdcf37b_a_c81d5
            - token-macro:444.v52de7e9c573d
            - trilead-api:2.192.vc50a_d147e369
            - variant:70.va_d9f17f859e0
            - workflow-aggregator:600.vb_57cdd26fdd7
            - workflow-api:1363.v03f731255494
            - workflow-basic-steps:1079.vce64b_a_929c5a_
            - workflow-cps:4032.vf3248d9c3fee
            - workflow-durable-task-step:1405.v1fcd4a_d00096
            - workflow-job:1505.vea_4b_20a_4a_495
            - workflow-multibranch:803.v08103b_87c280
            - workflow-scm-step:437.v05a_f66b_e5ef8
            - workflow-step-api:700.v6e45cb_a_5a_a_21
            - workflow-support:961.v51869f7b_d409
          additionalPlugins:
            - build-blocker-plugin:166.vc82fc20b_a_ed6
            - build-user-vars-plugin:195.v8c35f9d5c3dc
            - configuration-as-code-groovy:1.1
            - gerrit-code-review:0.4.9
            - gerrit-trigger:2.42.0
            - github-branch-source:1810.v913311241fa_9
            - google-compute-engine:4.683.v0ce26579a_ee7
            - google-kubernetes-engine:0.430.v4cc1fa_1847a_9
            - job-dsl:1.91
            - keycloak:2.3.2
            - kubernetes:4314.v5b_846cf499eb_
            - kubernetes-credentials:190.v03c305394deb_
            - pipeline-stage-view:2.37
            - ssh-slaves:3.1031.v72c6b_883b_869
            - startup-trigger-plugin:2.9.4
            - timestamper:1.28
          additionalExistingSecrets:
            - name: jenkins-keycloak
              keyName: keycloakJson
            - name: jenkins-gerrit-ssh-private-key
              keyName: privateKey
            - name: jenkins-gce-creds
              keyName: gce-creds-json
            - name: jenkins-gerrit-http-password
              keyName: password
          javaOpts: "-Dcom.cloudbees.workflow.rest.external.JobExt.maxRunsPerJob=50"
          enableRawHtmlMarkupFormatter: true
          markupFormatter: rawHtml
          JCasC:
            enabled: true
            securityRealm: |-
              keycloak:
                keycloakJson: ${jenkins-keycloak-keycloakJson}
                keycloakRespectAccessTokenTimeout: false
                keycloakValidate: false
            authorizationStrategy: |-
              loggedInUsersCanDoAnything:
                allowAnonymousRead: false
            defaultConfig: true
            configScripts:
              welcome-message: |
                credentials:
                  system:
                    domainCredentials:
                      - credentials:
                        - googleRobotPrivateKey:
                            description: "GCE Creds"
                            id: "gce-creds"
                            scope: GLOBAL
                            projectId: {{ .Values.config.projectID }}
                            serviceAccountConfig:
                              json:
                                filename: {{ .Values.config.projectID }}.json"
                                secretJsonKey: ${base64:${jenkins-gce-creds-gce-creds-json}}
                jenkins:
                  systemMessage: Welcome to Horizon SDV server.
                  clouds:
                    - computeEngine:
                        cloudName: cuttlefish-vm-main
                        configurations:
                          - bootDiskAutoDelete: true
                            bootDiskSizeGb: 10
                            bootDiskSizeGbStr: "10"
                            bootDiskType: "https://www.googleapis.com/compute/v1/projects/{{ .Values.config.projectID }}/zones/{{ .Values.config.zone }}/diskTypes/hyperdisk-balanced"
                            description: "cuttlefish-vm-main"
                            javaExecPath: "/usr/bin/java"
                            labelSet:
                              - name: "cuttlefish-vm-main"
                            labelString: "cuttlefish-vm-main"
                            labels: "cuttlefish-vm-main"
                            launchTimeoutSeconds: 300
                            launchTimeoutSecondsStr: "300"
                            mode: NORMAL
                            namePrefix: "cuttlefish-vm-main"
                            numExecutors: 1
                            numExecutorsStr: "1"
                            oneShot: true
                            region: "https://www.googleapis.com/compute/v1/projects/{{ .Values.config.projectID }}/regions/{{ .Values.config.region }}"
                            remoteFs: "/home/jenkins"
                            retentionTimeMinutes: 6
                            retentionTimeMinutesStr: "6"
                            runAsUser: "jenkins"
                            sshConfiguration:
                              customPrivateKeyCredentialsId: "jenkins-cuttlefish-vm-ssh-private-key"
                            template: "https://www.googleapis.com/compute/v1/projects/{{ .Values.config.projectID }}/global/instanceTemplates/instance-template-cuttlefish-vm-main"
                            useInternalAddress: true
                            zone: "https://www.googleapis.com/compute/v1/projects/{{ .Values.config.projectID }}/zones/{{ .Values.config.zone }}"
                        credentialsId: "gce-creds"
                        instanceCapStr: "20"
                        noDelayProvisioning: true
                        projectId: {{ .Values.config.projectID }}
                    - computeEngine:
                        cloudName: "cuttlefish-vm-v110"
                        configurations:
                        - bootDiskAutoDelete: true
                          bootDiskSizeGb: 10
                          bootDiskSizeGbStr: "10"
                          bootDiskType: "https://www.googleapis.com/compute/v1/projects/{{ .Values.config.projectID }}/zones/{{ .Values.config.zone }}/diskTypes/hyperdisk-balanced"
                          description: "cuttlefish-vm-v110"
                          javaExecPath: "/usr/bin/java"
                          labelSet:
                          - name: "cuttlefish-vm-v110"
                          labelString: "cuttlefish-vm-v110"
                          labels: "cuttlefish-vm-v110"
                          launchTimeoutSeconds: 300
                          launchTimeoutSecondsStr: "300"
                          mode: NORMAL
                          namePrefix: "cuttlefish-vm-v110"
                          numExecutors: 1
                          numExecutorsStr: "1"
                          oneShot: true
                          region: "https://www.googleapis.com/compute/v1/projects/{{ .Values.config.projectID }}/regions/{{ .Values.config.region }}"
                          remoteFs: "/home/jenkins"
                          retentionTimeMinutes: 6
                          retentionTimeMinutesStr: "6"
                          runAsUser: "jenkins"
                          sshConfiguration:
                            customPrivateKeyCredentialsId: "jenkins-cuttlefish-vm-ssh-private-key"
                          template: "https://www.googleapis.com/compute/v1/projects/{{ .Values.config.projectID }}/global/instanceTemplates/instance-template-cuttlefish-vm-v110"
                          useInternalAddress: true
                          zone: "https://www.googleapis.com/compute/v1/projects/{{ .Values.config.projectID }}/zones/{{ .Values.config.zone }}"
                        credentialsId: "gce-creds"
                        instanceCapStr: "20"
                        noDelayProvisioning: true
                        projectId: {{ .Values.config.projectID }}
                  globalNodeProperties:
                    - envVars:
                        env:
                        - key: "ANDROID_BUILD_BUCKET_ROOT_NAME"
                          value: {{ .Values.config.projectID }}-aaos
                        - key: "ANDROID_BUILD_DOCKER_ARTIFACT_PATH_NAME"
                          value: "horizon-sdv/aaos_builder"
                        - key: "CLOUD_REGION"
                          value: {{ .Values.config.region }}
                        - key: "CLOUD_ZONE"
                          value: {{ .Values.config.zone }}
                        - key: "CLOUD_PROJECT"
                          value: {{ .Values.config.projectID }}
                        - key: "GERRIT_CREDENTIALS_ID"
                          value: "jenkins-gerrit-http-password"
                        - key: "GERRIT_CUTTLEFISH_INSTANCE_TEMPLATE_LABEL"
                          value: "cuttlefish-vm-main"
                        - key: "HORIZON_DOMAIN"
                          value: {{ .Values.config.domain }}
                        - key: "JENKINS_SERVICE_ACCOUNT"
                          value: "jenkins-sa"
                        - key: "JENKINS_CACHE_STORAGE_CLASS_NAME"
                          value: "reclaimable-storage-class"
                        - key: "REPO_SYNC_JOBS"
                          value: "2"
                groovy:
                  - script: >
                      println("This is groovy !");
                jobs:
                  - script: >
                      folder('Android') {
                        displayName('Android Workflows')
                        description('<p>This folder contains pipelines and jobs related to environment administration, building, testing, and deploying Android applications.<br/>It includes workflows for administration, building and test tasks.</p>')
                      }
                  - script: >
                      folder('Android/Environment') {
                        displayName('Environment')
                        description('<p>This folder contains environment administrative jobs related to supporting Android workflows.</p>')
                      }
                  - script: >
                      folder('Android/Builds') {
                        displayName('Builds')
                        description('<p>This folder contains jobs to build Android targets.</p>')
                      }
                  - script: >
                      folder('Android/Tests') {
                        displayName('Tests')
                        description('<p>This folder contains jobs used to help test and validate Android builds.</p>')
                      }
                  - script: >
                      pipelineJob('Android/Environment/Docker Image Template') {
                         description('''
                          <p>This job builds the container image used (as the <tt>builder</tt> container) in other pipelines  to
                            <ul>
                                <li style="line-height:1.5">build Android targets &amp; Cuttlefish instances</li>
                                <li style="line-height:1.5">perform cleanup activities</li>
                            </ul>
                          </p>
                          <p>This image contains the tools required for building AAOS targets as well as the google cloud sdk and google repo command tool.</p>
                          <p>Each time a change is made to the dockerfile this job should be run once with <tt>NO_PUSH=false</tt>.</p> 
                          <p>The resulting image template is stored at <tt>{{ .Values.config.region }}-docker.pkg.dev/{{ .Values.config.projectID }}/ANDROID_BUILD_DOCKER_ARTIFACT_PATH_NAME</tt>
                          <br/>(where <tt>ANDROID_BUILD_DOCKER_ARTIFACT_PATH_NAME</tt> is an environment variable)
                          </p>
                          
                        ''')
                        triggers {
                          hudsonStartupTrigger {
                            nodeParameterName("")
                            label("")
                            quietPeriod("0")
                            runOnChoice("ON_CONNECT")
                          }
                        }
                        logRotator {
                          daysToKeep({{ .Values.config.workloads.android.logRotation.daysToKeep }})
                          numToKeep({{ .Values.config.workloads.android.logRotation.numToKeep }})
                        }
                        definition {
                          cpsScm {
                            lightweight()
                            scm {
                              git {
                                remote {
                                  url('{{ .Values.config.workloads.android.url }}')
                                  credentials('jenkins-github-creds')
                                }
                                branch('*/{{ .Values.config.workloads.android.branch }}')
                              }
                            }
                            scriptPath('workloads/android/pipelines/environment/docker_image_template/Jenkinsfile')
                          }
                        }
                      }
                  - script: >
                      pipelineJob('Android/Environment/CF Instance Template') {
                        description('''
                          <p>This job creates the GCE instance templates used by test pipelines 
                              to spin up cuttlefish-ready &amp; CTS-ready cloud instances which are then used to launch 
                              <a href="https://source.android.com/docs/devices/cuttlefish" target="_blank" title="Cuttlefish Virtual Device">CVD</a> 
                              and run 
                              <a href="https://source.android.com/docs/compatibility/cts" target="_blank" title="Compatibility Test Suite">CTS</a>
                              tests.</p>
                            <p>The name for the created instance template can either be auto-generated or user-provided -
                              the resulting artifact will be <tt>instance-template-&lt;name&gt;</tt>
                              <br/>if a user-defined name is used, the Jenkins CasC (jenkins.yaml) must be updated with a new computeEngine entry for the template (see README for details). 
                            </p>
                            <p>This job can also be used to delete outdated instances and associated artifacts.</p>
                            <p>To view the created instance templates, either go to the 
                            <a href="https://console.cloud.google.com/compute/instanceTemplates/list?inv=1&invt=Abqr1A&project={{ .Values.config.projectID }}" target="_blank">cloud console</a>      
                            or run the following command  (<a href="https://cloud.google.com/docs/authentication/gcloud" target="_blank">sign in</a> first): 
                            <br/><tt>gcloud compute instance-templates list | grep cuttlefish-vm</tt>
                            </p>
                            <p><b>Note:</b> During the process of creating an instance template, this pipeline also creates a custom image which is referenced by the created instance template.
                              <br/>These images can be viewed on the 
                              <a href="https://console.cloud.google.com/compute/images?project={{ .Values.config.projectID }}" target="_blank">cloud console</a> 

                              or with the following command (<a href="https://cloud.google.com/docs/authentication/gcloud" target="_blank">sign in</a> first):
                              <br/><tt>gcloud compute instances list | grep cuttlefish-vm</tt>
                            </p>
                        ''')
                        triggers {
                          hudsonStartupTrigger {
                            nodeParameterName("")
                            label("")
                            quietPeriod("0")
                            runOnChoice("ON_CONNECT")
                          }
                        }
                        logRotator {
                          daysToKeep({{ .Values.config.workloads.android.logRotation.daysToKeep }})
                          numToKeep({{ .Values.config.workloads.android.logRotation.numToKeep }})
                        }
                        definition {
                          cpsScm {
                            lightweight()
                            scm {
                              git {
                                remote {
                                  url('{{ .Values.config.workloads.android.url }}')
                                  credentials('jenkins-github-creds')
                                }
                                branch('*/{{ .Values.config.workloads.android.branch }}')
                              }
                            }
                            scriptPath('workloads/android/pipelines/environment/cf_instance_template/Jenkinsfile')
                          }
                        }
                      }
                  - script: >
                      pipelineJob('Android/Environment/Development Instance') {
                        description('''
                          <p>This job allows creation of temporary build instances that can be used to aid development.<br/>
                          Instances can be expensive and therefore there is a maximum up-time before the instance will automatically be terminated.</p>
                          <p>Access the instance via <tt>bastion</tt> host and <tt>kubectl</tt> command line tool, e.g.</p>
                          <p><tt>kubectl exec -it -n jenkins &lt;pod name&gt; -- bash</tt></p>
                          <p><b>Note:</b> users are responsible for saving their own work to persistent storage before expiry.</p>''')
                        triggers {
                          hudsonStartupTrigger {
                            nodeParameterName("")
                            label("")
                            quietPeriod("0")
                            runOnChoice("ON_CONNECT")
                          }
                        }
                        logRotator {
                          daysToKeep({{ .Values.config.workloads.android.logRotation.daysToKeep }})
                          numToKeep({{ .Values.config.workloads.android.logRotation.numToKeep }})
                        }
                        definition {
                          cpsScm {
                            lightweight()
                            scm {
                              git {
                                remote {
                                  url('{{ .Values.config.workloads.android.url }}')
                                  credentials('jenkins-github-creds')
                                }
                                branch('*/{{ .Values.config.workloads.android.branch }}')
                              }
                            }
                            scriptPath('workloads/android/pipelines/environment/dev_instance/Jenkinsfile')
                          }
                        }
                      }
                  - script: >
                      pipelineJob('Android/Environment/Delete Cuttlefish VM Instance') {
                        description('''
                           <p>This is a helper job which allows developers to delete Cuttlefish VM instances
                                <br/>- it is only intended to be used for clean-up purposes if expensive instances are left running when jobs fail / crash.
                            </p>
                            <p>To view running instances see 
                                <ul>
                                    <li style="line-height:1.5"><a href="http://{{ .Values.config.domain }}/jenkins/manage/computer/" target="_blank">http://{{ .Values.config.domain }}/jenkins/manage/computer/</a></li>
                                    <li style="line-height:1.5"><a href="https://console.cloud.google.com/compute/instances?project={{ .Values.config.projectID }}" target="_blank">https://console.cloud.google.com/compute/instances?project={{ .Values.config.projectID }}</a></li>
                                </ul>
                            </p>
                            <p><b>Note:</b> only VM Instances named with the <tt>cuttlefish-vm</tt> prefix can be deleted using this job.</p>
                            <!--
                            https://dev.horizon-sdv.com/jenkins/manage/computer/
                            https://console.cloud.google.com/compute/instances?project=sdva-2108202401
                            -->
                          ''')
                        triggers {
                          hudsonStartupTrigger {
                            nodeParameterName("")
                            label("")
                            quietPeriod("0")
                            runOnChoice("ON_CONNECT")
                          }
                        }
                        logRotator {
                          daysToKeep({{ .Values.config.workloads.android.logRotation.daysToKeep }})
                          numToKeep({{ .Values.config.workloads.android.logRotation.numToKeep }})
                        }
                        definition {
                          cpsScm {
                            lightweight()
                            scm {
                              git {
                                remote {
                                  url('{{ .Values.config.workloads.android.url }}')
                                  credentials('jenkins-github-creds')
                                }
                                branch('*/{{ .Values.config.workloads.android.branch }}')
                              }
                            }
                            scriptPath('workloads/android/pipelines/environment/delete_cf_vm_instance/Jenkinsfile')
                          }
                        }
                      }
                  - script: >
                      pipelineJob('Android/Environment/Delete MTK Connect Testbench') {
                        description('''
                          <p>This is a helper job which allows developers to delete any offline MTK Connect testbenches
                              <br/>- it is only intended to be used for clean-up purposes for when jobs fail / crash without performing the usual cleanup operations.
                          </p>
                          <p>To find the name of the testbench created by a test pipeline job, search for the string <i>"MTK Connect Testbench:"</i> in the console log;
                              it will be named as <tt>jobname_buildnumber</tt>. 
                          <br/>e.g. <tt>MTK Connect Testbench: Android/Tests/CVD_Launcher-5</tt>
                          </p>
                          <p>Access the MTK Connect Testbenches <a href="http://{{ .Values.config.domain }}/mtk-connect/portal/testbenches" target="_blank">here</a>.
                          </p>
                          ''')
                        triggers {
                          hudsonStartupTrigger {
                            nodeParameterName("")
                            label("")
                            quietPeriod("0")
                            runOnChoice("ON_CONNECT")
                          }
                        }
                        logRotator {
                          daysToKeep({{ .Values.config.workloads.android.logRotation.daysToKeep }})
                          numToKeep({{ .Values.config.workloads.android.logRotation.numToKeep }})
                        }
                        definition {
                          cpsScm {
                            lightweight()
                            scm {
                              git {
                                remote {
                                  url('{{ .Values.config.workloads.android.url }}')
                                  credentials('jenkins-github-creds')
                                }
                                branch('*/{{ .Values.config.workloads.android.branch }}')
                              }
                            }
                            scriptPath('workloads/android/pipelines/environment/delete_mtkc_testbench/Jenkinsfile')
                          }
                        }
                      }
                  - script: >
                      pipelineJob('Android/Builds/AAOS Builder') {
                        description('''
                          <p>This job is used to build Android Automotive virtual devices and platform targets from the provided source manifest.</p>
                          <p>The following builds are supported:
                          <ul>
                              <li style="line-height:1.5"><a href="https://source.android.com/docs/automotive/start/avd/android_virtual_device" target="_blank">Android Virtual Devices</a>
                              for use with 
                              <a href="https://source.android.com/docs/automotive/start/avd/android_virtual_device#share-an-avd-image-with-android-studio-users" target="_blank">Android Studio</a></li> 
                              <li style="line-height:1.5"><a href="https://source.android.com/docs/devices/cuttlefish" target="_blank">Cuttlefish Virtual Devices</a> 
                              for use with <a href="https://source.android.com/docs/compatibility/cts" target="_blank">CTS</a></li>
                              <li style="line-height:1.5">Reference hardware platforms such as 
                              <a href="https://github.com/raspberry-vanilla/android_local_manifest" target="_blank">Rpi</a> and 
                              <a href="https://source.android.com/docs/automotive/start/pixelxl" target="_blank">Pixel Tablets</a></li>
                          </ul>
                          </p>
                          <p>Build outputs are stored in a google cloud storage bucket (see build artifact for location). </p>
                          <p>To view artifacts on gcloud run the following command (<a href="https://cloud.google.com/docs/authentication/gcloud" target="_blank">sign in</a> first): 
                                <br/><tt>gcloud storage ls gs://{{ .Values.config.projectID }}/aaos/Android/Builds/AAOS_Builder/<tt></tt>&lt;BUILD_NUMBER&gt;</tt></li>
                          </p>
                        ''')
                        triggers {
                          hudsonStartupTrigger {
                            nodeParameterName("")
                            label("")
                            quietPeriod("0")
                            runOnChoice("ON_CONNECT")
                          }
                        }
                        logRotator {
                          daysToKeep({{ .Values.config.workloads.android.logRotation.daysToKeep }})
                          numToKeep({{ .Values.config.workloads.android.logRotation.numToKeep }})
                        }
                        definition {
                          cpsScm {
                            lightweight()
                            scm {
                              git {
                                remote {
                                  url('{{ .Values.config.workloads.android.url }}')
                                  credentials('jenkins-github-creds')
                                }
                                branch('*/{{ .Values.config.workloads.android.branch }}')
                              }
                            }
                            scriptPath('workloads/android/pipelines/builds/aaos_builder/Jenkinsfile')
                          }
                        }
                      }
                  - script: >
                      pipelineJob('Android/Builds/CTS Builder') {
                        description('''
                          <p>This job builds the Android 
                              <a href="https://source.android.com/docs/compatibility/cts" target="_blank">Compatibility Test Suite</a> (CTS) 
                              from the provided source manifest.
                              <br/>This can then be used in the <i>CTS Execution</i> pipeline instead of the 
                              <a href="https://source.android.com/docs/compatibility/cts/downloads" target="_blank">google-released</a> 
                              version of CTS already downloaded.
                          </p>
                          <p>The job runs the same code as the <i>AAOS Builder</i> job but with the following differences:</p>
                          <ul>
                              <li style="line-height:1.5">lunch target provided must be of the cuttlefish variety (i.e. must start with <tt>aosp_cf</tt>)</li>
                              <li style="line-height:1.5">only the CTS package is built</li>
                          </ul>  
                          </p> 
                          <p>The output of this job is the CTS package <tt>android-cts.zip</tt> which contains 
                              <ul>
                                  <li style="line-height:1.5"><a href="https://source.android.com/docs/core/tests/tradefed" target="_blank">CTS Trade Federataion</a> 
                                    (<tt>cts-tradefed</tt>), the test harness for CTS</li>
                                  <li style="line-height:1.5">The full suite of CTS tests (not including 
                                    <a href="https://source.android.com/docs/compatibility/cts/verifier" target="_blank" title="CTS-Verifier: a set of CTS tests that must be run manually">CTS-V</a>
                                        tests)
                                  </li>
                              </ul> 
                          </p>
                          <p>The CTS package zip file is stored in a google cloud storage bucket (see build artifact for location). </p>
                          <p>To view artifacts on gcloud run the following command (<a href="https://cloud.google.com/docs/authentication/gcloud" target="_blank">sign in</a> first): 
                                <br/><tt>gcloud storage ls gs://{{ .Values.config.projectID }}aaos/Android/Builds/CTS_Builder/<tt></tt>&lt;BUILD_NUMBER&gt;</tt></li>
                          </p>
                        ''')
                        triggers {
                          hudsonStartupTrigger {
                            nodeParameterName("")
                            label("")
                            quietPeriod("0")
                            runOnChoice("ON_CONNECT")
                          }
                        }
                        logRotator {
                          daysToKeep({{ .Values.config.workloads.android.logRotation.daysToKeep }})
                          numToKeep({{ .Values.config.workloads.android.logRotation.numToKeep }})
                        }
                        definition {
                          cpsScm {
                            lightweight()
                            scm {
                              git {
                                remote {
                                  url('{{ .Values.config.workloads.android.url }}')
                                  credentials('jenkins-github-creds')
                                }
                                branch('*/{{ .Values.config.workloads.android.branch }}')
                              }
                            }
                            scriptPath('workloads/android/pipelines/builds/cts_builder/Jenkinsfile')
                          }
                        }
                      }
                  - script: >
                      pipelineJob('Android/Builds/Gerrit') {
                        description('''
                          <p>This verification job is triggered by a Gerrit patchset change.
                            <br/>Its purpose is to verify the integrity of the patchset change; it does this by 
                              <ul>
                                  <li style="line-height:1.5">building multiple targets (full target names derived from 
                                    <a href="https://source.android.com/docs/setup/reference/build-numbers#source-code-tags-and-builds" target="_blank">
                                        android tag</a>)</li>
                                  <li style="line-height:1.5">spinning up 
                                    <a href="https://source.android.com/docs/devices/cuttlefish" target="_blank" title="CVD">Cuttlefish Virtual Devices</a>
                                    using the cuttlefish artifact</li>
                                  <li style="line-height:1.5">performing a 
                                    <a href="https://source.android.com/docs/compatibility/cts" target="_blank" title="Compatibility Test Suite">CTS</a>
                                    run on the cuttlefish virtual devices</li>
                              </ul>
                          </p>
                          <p>All build artifacts are stored in a google cloud storage bucket. Summaries (including locations) are stored as job artifacts.</p>
                           <p>To view artifacts on gcloud run the following command (<a href="https://cloud.google.com/docs/authentication/gcloud" target="_blank">sign in</a> first): 
                                <br/><tt>gcloud storage ls gs://{{ .Values.config.projectID }}aaos/Android/Builds/Gerrit/<tt></tt>&lt;BUILD_NUMBER&gt;</tt></li>
                          </p>
                        ''')
                        triggers {
                          hudsonStartupTrigger {
                            nodeParameterName("")
                            label("")
                            quietPeriod("0")
                            runOnChoice("ON_CONNECT")
                          }
                        }
                        logRotator {
                          artifactDaysToKeep({{ .Values.config.workloads.android.logRotation.artifactDaysToKeep }})
                          artifactNumToKeep({{ .Values.config.workloads.android.logRotation.artifactNumToKeep }})
                          daysToKeep({{ .Values.config.workloads.android.logRotation.daysToKeep }})
                          numToKeep({{ .Values.config.workloads.android.logRotation.numToKeep }})
                        }
                        definition {
                          cpsScm {
                            lightweight()
                            scm {
                              git {
                                remote {
                                  url('{{ .Values.config.workloads.android.url }}')
                                  credentials('jenkins-github-creds')
                                }
                                branch('*/{{ .Values.config.workloads.android.branch }}')
                              }
                            }
                            scriptPath('workloads/android/pipelines/builds/gerrit/Jenkinsfile')
                          }
                        }
                      }
                  - script: >
                      pipelineJob('Android/Tests/CTS Execution') {
                        description('''
                          <p>This job allows users to execute the 
                              <a href="https://source.android.com/docs/compatibility/cts" target="_blank">Compatibility Test Suite</a> (CTS)
                              on their
                              <a href="https://source.android.com/docs/devices/cuttlefish" target="_blank">Cuttlefish Virtual Device</a> (CVD)
                              image builds.
                          </p>
                          
                          <p>The job runs on a virtual machine instance<sup>*</sup> which is cuttlefish-ready and CTS-ready (all tools and files pre-installed).
                            <br/><i><sup>*</sup>created from an instance template which is generated by the 'CF Instance Template' job</i> 

                          <p>The desired number of cuttlefish virtual devices are spun up using the specified image.
                          </p>
                          <p>The Compatibility Test Suite is then performed on the virtual devices
                              <ul>
                                  <li style="line-height:1.5"><a href="https://source.android.com/docs/core/tests/tradefed" target="_blank">CTS Trade Federataion</a></i> 
                                      (<tt>cts-tradefed</tt>) - the test harness for CTS - can distribute / shard the tests across the multiple virtual devices
                                      
                                  </li>
                                  <li style="line-height:1.5">the CTS version is either the default 
                                  <a href="https://source.android.com/docs/compatibility/cts/downloads" target="_blank">google-released</a> version or a test suite built by the <i>CTS Builder</i> job (if specified)</a></i>
                                  </li>
                                  <li style="line-height:1.5">the full CTS suite or a suite subset (in the form of a plan<sup>*</sup>)
                                    can be run, or an individual module<sup>*</sup> can also be specified
                                    <br/><sup>*</sup> lists of available plans and modules are included in the build artifacts. See 
                                    <a href="https://source.android.com/docs/compatibility/cts/command-console-v2" target=""_blank">here</a> for more info.
                              </ul>
                          </p>
                          <p>MTK Connect is used (optionally) so that users can view and/or interact with the virtual devices during testing (interaction during testing is not recommended).
                              <br/>Access the MTK Connect Testbenches <a href="http://{{ .Values.config.domain }}/mtk-connect/portal/testbenches" target="_blank">here</a> (name: <tt>jobname_buildnumber</tt>).
                          </p>
                          <p>Test results are saved as build artifacts.</p>
                          <p>Users can optionally keep the cuttlefish virtual devices alive for a certain amount of time after the CTS run has completed in order to facilitate debugging via MTK Connect. 
                          <br/>This option is only available when MTK Connect is enabled. </p>
                          <p><b>Note:</b> users are responsible for specifying a valid instance template - the job will hang if the specified template does not exist.
                          <br/>Available instance templates can be viewed in the <a href="https://console.cloud.google.com/compute/instanceTemplates/list?inv=1&invt=Abqr1A&project={{ .Values.config.projectID }}" target="_blank">cloud console</a>.
                          </p>
                        ''')
                        logRotator {
                          artifactDaysToKeep({{ .Values.config.workloads.android.logRotation.artifactDaysToKeep }})
                          artifactNumToKeep({{ .Values.config.workloads.android.logRotation.artifactNumToKeep }})
                          daysToKeep({{ .Values.config.workloads.android.logRotation.daysToKeep }})
                          numToKeep({{ .Values.config.workloads.android.logRotation.numToKeep }})
                        }
                        definition {
                          cpsScm {
                            lightweight()
                            scm {
                              git {
                                remote {
                                  url('{{ .Values.config.workloads.android.url }}')
                                  credentials('jenkins-github-creds')
                                }
                                branch('*/{{ .Values.config.workloads.android.branch }}')
                              }
                            }
                            scriptPath('workloads/android/pipelines/tests/cts_execution/Jenkinsfile')
                          }
                        }
                      }
                  - script: >
                      pipelineJob('Android/Tests/CVD Launcher') {
                        description('''
                          <p>This job is used to test 
                              <a href="https://source.android.com/docs/devices/cuttlefish" target="_blank" title="Cuttlefish Virtual Device">CVD</a> 
                              image builds by spinning up one or more virtual device(s) using the specified image.
                          </p>
                          <p>The job runs on a virtual machine instance<sup>*</sup> which is cuttlefish-ready  (all tools and files pre-installed).
                              <br/><i><sup>*</sup>created from an instance template which is generated by the 'CF Instance Template' job</i> 
                          </p>
                          <p>Once the specified number of virtual devices have been initialised, they are kept alive for the required amount of time and then killed.</p>
                          <p>MTK Connect is used so that users can view and/or interact with the virtual device(s) via UI and/or adb.
                              <br/>Access the MTK Connect Testbenches <a href="http://{{ .Values.config.domain }}/mtk-connect/portal/testbenches" target="_blank">here</a> (name: <tt>jobname_buildnumber</tt>).
                          </p>
                          <p><b>Note:</b> users are responsible for specifying a valid instance template - the job will hang if the specified template does not exist.
                          <br/>Available instance templates can be viewed in the <a href="https://console.cloud.google.com/compute/instanceTemplates/list?inv=1&invt=Abqr1A&project={{ .Values.config.projectID }}" target="_blank">cloud console</a>.
                          </p>
                        ''')
                        logRotator {
                          artifactDaysToKeep({{ .Values.config.workloads.android.logRotation.artifactDaysToKeep }})
                          artifactNumToKeep({{ .Values.config.workloads.android.logRotation.artifactNumToKeep }})
                          daysToKeep({{ .Values.config.workloads.android.logRotation.daysToKeep }})
                          numToKeep({{ .Values.config.workloads.android.logRotation.numToKeep }})
                        }
                        definition {
                          cpsScm {
                            lightweight()
                            scm {
                              git {
                                remote {
                                  url('{{ .Values.config.workloads.android.url }}')
                                  credentials('jenkins-github-creds')
                                }
                                branch('*/{{ .Values.config.workloads.android.branch }}')
                              }
                            }
                            scriptPath('workloads/android/pipelines/tests/cvd_launcher/Jenkinsfile')
                          }
                        }
                      }
                unclassified:
                  buildUserVars:
                    allBuilds: true
                  gerrit-trigger:
                    servers:
                      - name: "Gerrit"
                        noConnectionOnStartup: false
                        config:
                          buildCurrentPatchesOnly:
                            abortAbandonedPatchsets: false
                            abortManualPatchsets: false
                            abortNewPatchsets: false
                            abortSameTopic: false
                            enabled: false
                          categories:
                            - verdictDescription: "Code Review"
                              verdictValue: "Code-Review"
                            - verdictDescription: "Verified"
                              verdictValue: "Verified"
                          gerritAuthKeyFile: "/run/secrets/additional/jenkins-gerrit-ssh-private-key-privateKey"
                          gerritFrontEndUrl: "https://{{ .Values.config.domain }}/gerrit/"
                          gerritHostName: "gerrit-service.gerrit.svc.cluster.local"
                          gerritUserName: "gerrit-admin"
                          useRestApi: false
                  timestamper:
                    allPipelines: true
                    systemTimeFormat: "'<b>'yyyy-MM-dd HH:mm:ss.SSS'</b> '"
                    elapsedTimeFormat: "'<b>'HH:mm:ss.S'</b> '"
  destination:
    server: https://kubernetes.default.svc
    namespace: jenkins
  syncPolicy:
    syncOptions:
      - CreateNamespace=true
    automated: {}
