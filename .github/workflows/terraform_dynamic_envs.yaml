name: used - Terraform dnamic envs

on:
  workflow_call:
    secrets:
      wif-provider:
        required: false
        description: "Workload Identity Federation provider"
      gcp-sa:
        required: false
        description: "GCP Service account to impersonate"
      gh-app-key:
        required: false
        description: "Github App Private Key"

    inputs:
      environment:
        required: false
        description: "environment to use"
        type: string
      path:
        required: false
        description: "Terraform directory"
        default: "terraform"
        type: string
      wif-provider:
        required: false
        description: "Workload Identity Federation provider"
        type: string
      gcp-sa:
        required: false
        description: "GCP Service account to impersonate"
        type: string
      terraform-version:
        required: false
        default: latest
        type: string
      terraform-apply:
        required: false
        default: false
        type: boolean

jobs:
  checkov:
    uses: ./.github/workflows/checkov.yaml
    secrets:
      gh-app-key: "${{ secrets.gh-app-key }}"
    with:
      environment: "${{ inputs.environment }}"
      directory: terraform

  tflint:
    uses: ./.github/workflows/terraform_lint.yaml
    with:
      terraform-path: ${{ inputs.path }}

  trivy:
    permissions:
      contents: read
      pull-requests: write
    uses: ./.github/workflows/trivy_secret_scan.yaml

  terraformfmt:
    uses: ./.github/workflows/terraform_fmt.yaml
    with:
      terraform-path: ${{ inputs.path }}
      terraform-version: ${{ inputs.terraform-version }}

  get-phase:
    name: Determine if it's plan or apply
    runs-on: self-hosted
    outputs:
      phase: ${{ steps.get-env.outputs.phase }}
    steps:
    - name: get phase
      id: get-env
      shell: bash
      run: |
        if [[ "${{ github.ref }}" == 'refs/heads/main' ]]; then
          echo "phase=apply" >> $GITHUB_OUTPUT;
        else
          echo "phase=plan" >> $GITHUB_OUTPUT;
        fi

  create-secrets-env:
    name: Create env from secrets
    runs-on: self-hosted
    environment: ${{ inputs.environment }}
    steps:
    - name: create secrets phase
      id: create-secrets-env
      shell: bash
      run: |
        echo "TF_VAR_sdv_gh_app_id=${{ vars.GH_APP_ID }}" >> $GITHUB_ENV;
        echo "TF_VAR_sdv_gh_installation_id=${{ vars.GH_INSTALLATION_ID }}" >> $GITHUB_ENV;

  terraform:
    needs: [checkov,trivy,terraformfmt,tflint,get-phase,create-secrets-env]
    uses: ./.github/workflows/terraform.yaml
    concurrency:
      group: terraform-${{ inputs.environment }}
    permissions:
     contents: 'read'
     id-token: 'write'
     pull-requests: 'write'
    secrets:
      gcp-sa: "${{ secrets.gcp-sa }}"
      wif-provider: "${{ secrets.wif-provider }}"
      sdv-secret: "${{ secrets.sdv-secret }}"
      gh-app-key: "${{ secrets.gh-app-key }}"
    with:
      terraform-version: ${{ inputs.terraform-version }}
      directory: ${{ inputs.path }}
      environment: ${{ inputs.environment }}
